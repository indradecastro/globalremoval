---
title: "Clean 'Removal' data"
author: "indra deCastro"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

<style type="text/css">
.table {

    width: 40%;

}
</style>

```{r setup, include=FALSE}
# setwd("/home/indra/Documents/20160101.Noriega.exp.remocion/")
knitr::opts_knit$set(root.dir ="/home/indra/Documents/20160101.Noriega.exp.remocion/", message=F, warning=F, verbose=F, comment=F)
knitr::opts_chunk$set(message=F, warning=F, verbose=F, echo=F, autodep=T, cache=T, fig.width=10)
options(markdown.HTML.header = system.file("misc", "datatables.html", package = "knitr"))
```

## Import data
```{r import, echo=T}
raw <- read.table("data/removal.csv", header=T, sep=";", na.strings=c("-", "N/A"))
```

## Check for table consistency
i.e. check for: Number of Sites? number of treatments? number of experimental units?...  
Number of sites: `r length(unique(raw$codigo_parcela))`
```{r labels}
labels <- 1:4
apply(raw[labels], 2, table)
```
Why are treatments called "1/2" instead of "Int/Ext"??  
I suggest that anything that is NOT a number (=continous variables) should be given a name (with letters).  

```{r renametreatments, echo=T}
raw$manejo <- factor(raw$manejo, labels=c("Int", "Ext"))
table(raw$manejo)
```


## Explore data
i.e. check for: ranges of data make sense? no evident outliers? number of NA values?...
```{r exploredata}
summary(raw[-labels])
```

Summarize percentage of NAs in each variable:
```{r}
t(t(data.frame("perc.NAs"=apply(raw[-labels], 2, function(x){round((nrow(raw)-length(which(complete.cases(x)))) / nrow(raw) *100, 2)}))))
```

### All variables
```{r othervars}
summary(raw[-labels])

## put histograms on the diagonal
panel.hist <- function(x, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(usr[1:2], 0, 1.5) )
    h <- hist(x, plot = FALSE)
    breaks <- h$breaks; nB <- length(breaks)
    y <- h$counts; y <- y/max(y)
    rect(breaks[-nB], 0, breaks[-1], y, col = "cyan", ...)
}
pairs(raw[-labels], bg = "grey80", diag.panel = panel.hist, cex.labels = 1, upper.panel=NULL)
# pairs(raw[-labels])
```

### dung_final_dry
There is an obvious outlier in data point in *dung_final_dry*:  
```{r outliers}
plot(raw$final_dung_dry, pch=c(1,19)[as.factor(raw$final_dung_dry==max(raw$final_dung_dry, na.rm=T))], col=c("black", "red")[as.factor(raw$final_dung_dry==max(raw$final_dung_dry, na.rm=T))], cex=c(1,2)[as.factor(raw$final_dung_dry==max(raw$final_dung_dry, na.rm=T))])

t(raw[which(raw$final_dung_dry==max(raw$final_dung_dry, na.rm=T)),])
```
Is is a typo when digitalizing data?  
Look at the values in the replicates of this experiment:  
```{r}
plot(raw[raw$codigo_parcela=="AUS02Int","final_dung_dry"])
summary(raw[raw$codigo_parcela=="AUS02Int","final_dung_dry"])

# correct 
raw[which(raw$final_dung_dry==max(raw$final_dung_dry, na.rm=T)), "final_dung_dry"] <- 161
```
Should the first "1" be deleted? Thus, the correct value be 161.0?  
I have corrected it for future exploration, but NOT in the original data table.  

### Dry variables
Moreover,  
The variable "dry_paper_bag"  
`r raw[which(raw$dry_paper_bag>20),"dry_paper_bag"]`  
and "cont_dung_dry" have a problem:  
`r raw[which(raw$cont_dung_dry>200),"cont_dung_dry"]`  
Most probably it is due to dragging the initial value (25.89 and 207.13) in Excel to complete the other values.

```{r testdrypaper}
raw$newdrypaper <- raw$dry_paper_bag
raw$newdrypaper[raw$newdrypaper>25.89] <- 25.89

raw$newcontdung <- raw$cont_dung_dry
raw$newcontdung[raw$newcontdung>207.13] <- 207.13

pairs(raw[c("initial_dung", "final_dung_wet", "final_dung_dry", "newcontdung", "paper_bag", "newdrypaper")], bg = "grey80", diag.panel = panel.hist, cex.labels = 1, upper.panel=NULL)
```

### Variables of interest
```{r}
raw <- raw[-grep(x=names(raw), pattern=c("dry|bag|new"))]
```

### Initial dung
```{r initialdung}
hist(raw$initial_dung, main="Weight of initial dung (grams)", xlab="grams of wet dung", ylab="number of samples", breaks=seq(min(raw$initial_dung)-1, max(raw$initial_dung)+1, 0.5)); box()

table(cut(raw$initial_dung, breaks=c(280,299.9,300,320), labels=c("smaller", "300gr", "bigger")))
```

Most of the samples (`r round(length(which(raw$initial_dung==300.0)) / nrow(raw), 2)`%) weigh exactly 300.0 grams.  
However, there are `r length(which(raw$initial_dung>300.0))` samples (`r round(length(which(raw$initial_dung>300.0)) / nrow(raw), 2)`%) over that weight.

### Final dung (wet)
```{r}
hist(raw$final_dung_wet, main="Weight of final dung (grams)", xlab="grams of wet dung", ylab="number of samples", breaks=seq(min(raw$final_dung_wet, na.rm=T)-1, max(raw$final_dung_wet, na.rm=T)+1, 2)); box()

# table(cut(raw$final_dung_wet, breaks=c(0,299.9,300,320), labels=c("smaller", "300gr", "bigger")))
```

### Removal: Compute and explore
The complete removal formula is:  
*Removal rate = (ExpIniWet - (ExpFinWet + WaterLoss)) / 48h*  
Where *WaterLoss* is calculated as *ConIniWet - ConFinWet*  using the control experiments.  

### Water loss (evaporation in control experiments)
```{r realremoval}
library(plyr)
waterdif <- ddply(raw, .(codigo_parcela, unidad, manejo, no_unidad), .fun=summarize, 
                  "waterdif" = initial_dung - final_dung_wet)

waterdif.cont <- waterdif[waterdif$unidad=="Cont",]
waterdif.cont$ID <- strtrim(waterdif.cont$codigo_parcela, width=5)

# significance
water.pval <- ddply(waterdif.cont, .(ID), summarize,
                    "pval"=wilcox.test(waterdif ~ manejo)$p.value)
                    

waterdif.cont <- merge(waterdif.cont, water.pval)
waterdif.cont <- arrange(waterdif.cont, pval)
waterdif.cont$ID <- factor(waterdif.cont$ID, levels=unique(waterdif.cont$ID))

# plotting
library(ggplot2)
library(ggsignif)
white.violins <- ggplot(waterdif.cont) +
      aes(x=manejo, y=waterdif) +
      geom_violin() +
      facet_wrap(~ID, ncol=4) +
      labs(x="manejo", y="water loss", title="Evaporation in each treatment") +
      scale_y_continuous(expand = c(0,0), limits=c(0,300)) +
      geom_signif(comparisons = list(c("Int", "Ext")), map_signif_level=TRUE)

white.violins
```
Note that the water loss is different (wilcoxon test) between SOME Intensive and Extensive treatments.  
**Is this reasonable??**  
Are there important habitat differences between Intensive and Extensive treatments?  
**Where Control experiments really beetle-free??**



### Removal rate
Are these observations of simple dung difference correct?  
```{r dungaddition}
xp <- raw[raw$unidad!="Cont",]
dungdif <- xp$initial_dung - xp$final_dung_wet
plot(dungdif, pch=c(1,19)[as.factor(dungdif<0)], col=c("black", "red")[as.factor(dungdif<0)]); abline(h=0)

library(DT)
xp[which(dungdif<0),1:6] %>% 
      datatable(rownames=F)

qplot(dungdif, geom = "histogram", fill = dungdif > 0, binwidth=4, xlab="weight diff (water not considered)")
```
Dung increased during experiment, there was **NO** removal, but addition of dung!  
Percentage of experiments with weight increase: `r round(100*nrow(xp[which(dungdif<0),])/nrow(xp),2)`%  

**This percentage is even higher if we consider water loss:**
```{r removalhist, echo=F}
H2O.loss <- ddply(waterdif[waterdif$unidad=="Cont",], .(codigo_parcela, manejo), summarise,
                  "H2O.loss" = mean(waterdif, na.rm=T))
xp <- merge(xp, H2O.loss[,c("codigo_parcela", "H2O.loss")])
xp <- xp[,c("codigo_parcela", "manejo", "unidad", "no_unidad", "initial_dung", "final_dung_wet", "H2O.loss")]

xp$rem48 <- (xp$initial_dung - (xp$final_dung_wet + xp$H2O.loss))/48

qplot(rem48, data=xp, geom = "histogram", fill = rem48 > 0, binwidth=0.1, xlab="Removal rate in 48h (gr/h)")
```
Percentage of experiments with weight increase: `r round(100*nrow(xp[which(xp$rem48<0),])/nrow(xp),2)`%  

Table **only showing experiments with negative** removal rate (=*increase of weight*)
```{r, eval=F}
xp[which(xp$rem48<0),] %>% 
      datatable(rownames=F) %>% 
      formatRound(columns=c("H2O.loss", "rem48"), digits=2)
```

```{r}
xp[which(xp$rem48<0),]

xp[which(xp$rem48<0),] %>% 
      datatable(rownames=F) %>% 
      formatRound(columns=c("H2O.loss", "rem48"), digits=2)
```

